// Odds Intelligence - Data Model (PostgreSQL for production)

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Sport {
  id          String   @id @default(cuid())
  key         String   @unique
  name        String
  category    String
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  competitions Competition[]
}

model Competition {
  id          String   @id @default(cuid())
  externalId  String?  @unique
  name        String
  sportId     String
  country     String?
  tier        Int      @default(2)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  sport       Sport    @relation(fields: [sportId], references: [id])
  events      Event[]
}

model Event {
  id              String   @id @default(cuid())
  externalId      String?  @unique
  competitionId   String
  homeTeam        String?
  awayTeam        String?
  homePlayer      String?
  awayPlayer      String?
  commenceTime    DateTime
  status          String   @default("scheduled")
  sportKey        String
  sourceApi       String   @default("the_odds_api")
  lastSyncAt      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  competition     Competition @relation(fields: [competitionId], references: [id])
  oddsSnapshots   OddsSnapshot[]
  arbitrageOps    ArbitrageOpportunity[]
  
  @@index([commenceTime])
  @@index([status])
}

model Bookmaker {
  id              String   @id @default(cuid())
  key             String   @unique
  name            String
  type            String   @default("bookmaker")
  commission      Float    @default(0.0)
  isActive        Boolean  @default(true)
  lastSyncAt      DateTime?
  apiEndpoint     String?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  oddsSnapshots   OddsSnapshot[]
}

model MarketType {
  id          String   @id @default(cuid())
  key         String   @unique
  name        String
  description String?
  isThreeWay  Boolean  @default(false)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  
  oddsSnapshots OddsSnapshot[]
}

model OddsSnapshot {
  id              String   @id @default(cuid())
  eventId         String
  bookmakerId     String
  marketTypeId    String?
  marketType      String   @default("h2h")
  
  oddsHome        Float
  oddsDraw        Float?
  oddsAway        Float
  
  point           Float?
  oddsOver        Float?
  oddsUnder       Float?
  
  impliedProbHome Float?
  impliedProbDraw Float?
  impliedProbAway Float?
  margin          Float?
  
  rawResponse     String?
  capturedAt      DateTime @default(now())
  sourceApi       String
  latency         Int?
  
  event           Event        @relation(fields: [eventId], references: [id])
  bookmaker       Bookmaker    @relation(fields: [bookmakerId], references: [id])
  marketTypeRef   MarketType?  @relation(fields: [marketTypeId], references: [id])
  
  @@index([eventId, bookmakerId])
}

model ArbitrageOpportunity {
  id                  String   @id @default(cuid())
  eventId             String
  
  marketType          String
  isThreeWay          Boolean
  
  bookmakerHomeId     String
  oddsHome            Float
  bookmakerAwayId     String
  oddsAway            Float
  bookmakerDrawId     String?
  oddsDraw            Float?
  
  totalImpliedProb    Float
  arbitrageMargin     Float
  profitPercentage    Float
  
  recommendedStakeHome Float
  recommendedStakeAway Float
  recommendedStakeDraw Float?
  expectedProfit       Float
  
  commissionAdjustment Float   @default(0)
  slippageEstimate    Float    @default(0)
  latencyRisk         String   @default("low")
  
  maxStakeEstimate    Float?
  liquidityScore      Int      @default(50)
  
  qualityScore        Int      @default(0)
  qualityGrade        String   @default("C")
  
  status              String   @default("active")
  detectedAt          DateTime @default(now())
  expiresAt           DateTime?
  
  calculationVersion  String   @default("1.0")
  notes               String?
  
  event               Event    @relation(fields: [eventId], references: [id])
  alerts              Alert[]
  
  @@index([detectedAt])
  @@index([status])
}

model Alert {
  id              String   @id @default(cuid())
  opportunityId   String
  channel         String
  recipient       String
  
  title           String
  message         String
  dataJson        String?
  
  status          String   @default("pending")
  sentAt          DateTime?
  errorMessage    String?
  retryCount      Int      @default(0)
  
  opportunity     ArbitrageOpportunity @relation(fields: [opportunityId], references: [id])
  
  @@index([status])
}

model UserSettings {
  id              String   @id @default(cuid())
  
  minMargin       Float    @default(0.02)
  maxLatencyRisk  String   @default("medium")
  minLiquidity    Int      @default(30)
  
  sportsFilter    String?
  marketsFilter   String?
  bookmakersFilter String?
  
  maxStakePerBet  Float    @default(100)
  maxDailyExposure Float   @default(1000)
  
  telegramChatId  String?
  telegramEnabled Boolean  @default(false)
  emailEnabled    Boolean  @default(false)
  emailAddress    String?
  webhookUrl      String?
  webhookEnabled  Boolean  @default(false)
  
  quietHoursStart String?
  quietHoursEnd   String?
  timezone        String  @default("Europe/Madrid")
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model ApiCredential {
  id              String   @id @default(cuid())
  provider        String   @unique
  apiKey          String?
  apiSecret       String?
  isActive        Boolean  @default(true)
  rateLimitPerMin Int?
  rateLimitPerDay Int?
  currentUsage    Int      @default(0)
  usageResetAt    DateTime?
  lastUsedAt      DateTime?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model AuditLog {
  id              String   @id @default(cuid())
  action          String
  entityType      String
  entityId        String?
  
  dataBefore      String?
  dataAfter       String?
  
  source          String
  success         Boolean  @default(true)
  errorMessage    String?
  
  duration        Int?
  createdAt       DateTime @default(now())
  
  @@index([action])
}

model SystemMetric {
  id              String   @id @default(cuid())
  metricName      String
  metricValue     Float
  unit            String?
  tags            String?
  recordedAt      DateTime @default(now())
  
  @@index([metricName])
}

model SyncState {
  id                String    @id @default(cuid())
  provider          String
  sportKey          String?
  lastSyncAt        DateTime?
  lastSuccessAt     DateTime?
  lastErrorAt       DateTime?
  lastError         String?
  consecutiveErrors Int       @default(0)
  totalSyncs        Int       @default(0)
  totalErrors       Int       @default(0)
  isActive          Boolean   @default(true)
  nextSyncAt        DateTime?
  
  @@unique([provider, sportKey])
}
